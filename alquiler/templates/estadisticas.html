{% extends 'base.html' %}
{% load static %}

{% block title %} Equipos más alquilados{% endblock %}

{% block page_title %} Equipos más alquilados{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'alquiler/css/estadisticas.css' %}">
{% endblock %}

{% block content %}
<div class="contenedor">
    <a href="{% url 'listar_equipos' %}" class="btn-back">
        <i class="fas fa-arrow-left"></i> Volver a la lista
    </a>

    <div class="grafico-container">
        <!-- CORREGIDO: Los datos ya están en formato JSON -->
        <canvas id="grafico" width="800" height="400" 
                data-labels='{{ labels }}' 
                data-datos='{{ datos }}'>
        </canvas>
    </div>

    {% if equipos %}
    <h3>Detalles por equipo</h3>
    <table class="tabla-detalles">
        <thead>
            <tr>
                <th>Equipo</th>
                <th>Total Alquileres</th>
                <th>Clientes frecuentes</th>
                <th>Último alquiler</th>
                <th>Cliente último alquiler</th>
            </tr>
        </thead>
        <tbody>
            {% for equipo in equipos %}
            <tr>
                <td>{{ equipo.marca }} {{ equipo.modelo }}</td>
                <td class="text-center">{{ equipo.total_alquileres }}</td>
                <td>
                    {% if equipo.clientes_frecuentes %}
                        {% for cliente in equipo.clientes_frecuentes %}
                            {{ cliente }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    {% else %}
                        Sin datos
                    {% endif %}
                </td>
                <td>
                    {% if equipo.ultimo_alquiler %}
                        {{ equipo.ultimo_alquiler.fecha_inicio|date:"d/m/Y" }}
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                <td>
                    {% if equipo.ultimo_alquiler %}
                        {{ equipo.ultimo_alquiler.cliente.nombre }}
                    {% else %}
                        N/A
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="alert alert-info">
        No hay suficientes datos de alquileres para mostrar estadísticas.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/grafico_equipos.js' %}"></script>
{% endblock %}